# -*- coding: utf-8 -*-
# !/usr/bin/env python
"""
-------------------------------------------------
   File     : xzw_spider.py
   Author   : CoderPig
   date     : 2020-12-11 20:05
   Desc     : 爬取星座屋每日运势保存到csv和Excel中
-------------------------------------------------
"""
import xlwt
import xlrd
import csv
import requests as r
from pyquery import PyQuery as pq
import re
import os

base_url = 'https://www.xzw.com/fortune/{}/'
# 星座后缀列表
kind_list = ['aries', 'taurus', 'gemini', 'cancer', 'leo', 'virgo',
             'libra', 'scorpio', 'sagittarius', 'capricorn', 'aquarius', 'pisces']
headers = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) '
                  'Chrome/83.0.4103.97 Safari/537.36 '
}
# 表头
name_list = ['星座', '综合运势评分', '爱情运势评分', '事业学业评分', '财富运势评分', '健康指数', '商谈指数', '幸运颜色', '幸运数字',
             '速配星座', '短评', '综合运势', '爱情运势', '事业学业', '财富运势', '健康运势']

output_dir = os.path.join(os.getcwd(), 'out')
csv_file_path = os.path.join(os.path.join(output_dir, 'constellation.csv'))
excel_file_path = os.path.join(os.path.join(output_dir, 'constellation.xlsx'))

score_pattern = re.compile(r'width:(\d+)px;')


class Constellation:
    def __init__(self, constellation=None, total_fortune_score=None, love_fortune_score=None, career_fortune_score=None,
                 wealth_fortune_score=None, health_percent=None, talk_percent=None, lucky_color=None, lucky_number=None,
                 match_constellation=None, short_comment=None, total_fortune=None, love_fortune=None,
                 career_fortune=None, wealth_fortune=None, health=None):
        self.constellation = constellation  # 星座名
        self.total_fortune_score = total_fortune_score  # 综合运势评分
        self.love_fortune_score = love_fortune_score  # 爱情运势评分
        self.career_fortune_score = career_fortune_score  # 事业学业评分
        self.wealth_fortune_score = wealth_fortune_score  # 财富运势评分
        self.health_percent = health_percent  # 健康指数
        self.talk_percent = talk_percent  # 商谈指数
        self.lucky_color = lucky_color  # 幸运颜色
        self.lucky_number = lucky_number  # 幸运数字
        self.match_constellation = match_constellation  # 速配星座
        self.short_comment = short_comment  # 短评
        self.total_fortune = total_fortune  # 综合运势
        self.love_fortune = love_fortune  # 爱情运势
        self.career_fortune = career_fortune  # 事业学业
        self.wealth_fortune = wealth_fortune  # 财富运势
        self.health = health  # 健康运势

    def to_list(self):
        return [self.constellation, self.total_fortune_score, self.love_fortune_score, self.career_fortune_score,
                self.wealth_fortune_score,
                self.health_percent, self.talk_percent, self.lucky_color, self.lucky_number, self.match_constellation,
                self.short_comment, self.total_fortune, self.love_fortune, self.career_fortune, self.wealth_fortune,
                self.health]


def extract_constellation_info(kind):
    resp = r.get(base_url.format(kind), headers=headers)
    print("爬取：", resp.url)
    if resp is not None:
        doc = pq(resp.text)
        constellation = Constellation()
        constellation.constellation = doc('title').text()[0:3]
        for index, li in enumerate(doc('dl li').items()):
            if index == 0:
                constellation.total_fortune_score = int(score_pattern.search(li('span em').attr('style')).group(1)) / 16
            elif index == 1:
                constellation.love_fortune_score = int(score_pattern.search(li('span em').attr('style')).group(1)) / 16
            elif index == 2:
                constellation.career_fortune_score = int(
                    score_pattern.search(li('span em').attr('style')).group(1)) / 16
            elif index == 3:
                constellation.wealth_fortune_score = int(
                    score_pattern.search(li('span em').attr('style')).group(1)) / 16
            elif index == 4:
                constellation.health_percent = li.text().split('：')[-1]
            elif index == 5:
                constellation.talk_percent = li.text().split('：')[-1]
            elif index == 6:
                constellation.lucky_color = li.text().split('：')[-1]
            elif index == 7:
                constellation.lucky_number = li.text().split('：')[-1]
            elif index == 8:
                constellation.match_constellation = li.text().split('：')[-1]
            else:
                constellation.short_comment = li.text().split('：')[-1]
        for index, span in enumerate(doc('.c_cont p span').items()):
            if index == 0:
                constellation.total_fortune = span.text()
            elif index == 1:
                constellation.love_fortune = span.text()
            elif index == 2:
                constellation.career_fortune = span.text()
            elif index == 3:
                constellation.wealth_fortune = span.text()
            else:
                constellation.health = span.text()
        return constellation.to_list()


# 写入csv
def write_to_csv(data_list, file_path):
    with open(file_path, 'a+', newline='') as f:
        writer = csv.writer(f)
        for row in data_list:
            writer.writerow(row)


# 写入Excel
def write_to_excel(data_list, file_path):
    workbook = xlwt.Workbook()
    sheet = workbook.add_sheet('每日运势', cell_overwrite_ok=True)
    for first_index, data in enumerate(data_list):
        for second_index, value in enumerate(data):
            if first_index == 0:
                sheet.write(first_index, second_index, value)
            else:
                sheet.write(first_index, second_index, value)
    workbook.save(file_path)


if __name__ == '__main__':
    if not os.path.exists(output_dir):
        os.mkdir(output_dir)
    constellation_list = [name_list]
    for k in kind_list:
        constellation_list.append(extract_constellation_info(k))
    write_to_csv(constellation_list, csv_file_path)
    write_to_excel(constellation_list, excel_file_path)
    print("数据写入完毕，请打开文件查看~")
